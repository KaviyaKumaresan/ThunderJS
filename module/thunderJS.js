"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var WebSocket=_interopDefault(require("isomorphic-ws"));function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _defineProperty(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function ownKeys(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(n);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})),t.push.apply(t,o)}return t}function _objectSpread2(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(t,!0).forEach(function(e){_defineProperty(n,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):ownKeys(t).forEach(function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))})}return n}var webInspectorSocket,requestsQueue={},listeners={},requestQueueResolver=function(e){if("string"==typeof e)try{e=JSON.parse(e.normalize())}catch(e){}if(e.id){var n=requestsQueue[e.id];n?("result"in e?n.resolve(e.result):n.reject(e.error),delete requestsQueue[e.id]):console.log("no pending request found with id "+e.id)}},notificationListener=function(n){if("string"==typeof n)try{n=JSON.parse(n.normalize())}catch(e){}if(!n.id&&n.method){var e=listeners[n.method];e&&Array.isArray(e)&&e.length&&e.forEach(function(e){e(n.params)})}},protocol="ws://",host="localhost",endpoint="/jsonrpc",port=80,makeWebsocketAddress=function(e){return[e&&e.protocol||protocol,e&&e.host||host,":"+(e&&e.port||port),e&&e.endpoint||endpoint].join("")},protocols="notification",connection=null,socket=null,connect=function(t){return new Promise(function(e,n){if(connection)e(connection);else try{socket||((socket=new WebSocket(makeWebsocketAddress(t),protocols)).addEventListener("message",function(e){requestQueueResolver(e.data)}),socket.addEventListener("message",function(e){notificationListener(e.data)}),socket.addEventListener("open",function(){notificationListener({method:"client.ThunderJS.events.connect"}),e(connection=socket)}),socket.addEventListener("close",function(){notificationListener({method:"client.ThunderJS.events.disconnect"}),connection=socket=null}))}catch(e){n(e)}})},makeBody=function(e,n,t,o,r){o&&delete o.version;var i={jsonrpc:"2.0",id:e,method:[n,r,t].join(".")};return!o&&!1!==o||"object"===_typeof(o)&&0===Object.keys(o).length||(i.params=o),i},getVersion=function(e,n,t){var o;return(o=t&&t.version)?o:e&&(e[n]||e.default)||1},id=0,makeId=function(){return id+=1},execRequest=function(e,n){connect(e).then(function(e){e.send(JSON.stringify(n))}).catch(console.error)},API=function(u){return{request:function(i,s,c){return new Promise(function(e,n){var t=makeId(),o=getVersion(u.versions,i,c),r=makeBody(t,i,s,c,o);u.debug&&(console.log(" "),console.log("API REQUEST:"),console.log(JSON.stringify(r,null,2)),console.log(" ")),requestsQueue[t]={body:r,resolve:e,reject:n},execRequest(u,r)})}}},DeviceInfo={freeRam:function(e){return this.call("systeminfo",e).then(function(e){return e.freeram})},version:function(e){return this.call("systeminfo",e).then(function(e){return e.version})}},methodMapping={"Console.messageAdded":"log","Canvas.canvasMemoryChanged":"canvasChange"},connect$1=function(o){var r=this;return new Promise(function(t,e){webInspectorSocket?t(webInspectorSocket):r.api.request("Controller","status").then(function(e){var n=e.filter(function(e){return"WebKitBrowser"===e.callsign}).shift().configuration.inspector.split(":").pop();(webInspectorSocket=new WebSocket("ws://".concat(r.options.host,":").concat(n,"/devtools/page/1"))).on("message",function(e){var n=JSON.parse(e);notificationListener({method:[o,methodMapping[n.method]].join("."),params:n.params})}),webInspectorSocket.on("open",function(){t(webInspectorSocket)})}).catch(e)})},WebInspector={register:function(e){connect$1.call(this,e.id).then(function(e){e.send('{"id":1,"method":"Console.enable"}')})},unregister:function(){connect$1.call(this).then(function(e){e.send('{"id":10,"method":"Console.disable"}')})}},plugins={DeviceInfo:DeviceInfo,WebInspector:WebInspector};function listener(n,t,e){var o=this,r=register.call(this,n,t,e);return{dispose:function(){var e=makeListenerId(n,t);listeners[e].splice(r,1),0===listeners[e].length&&unregister.call(o,n,t)}}}var api,makeListenerId=function(e,n){return["client",e,"events",n].join(".")},register=function(e,n,t){var o=makeListenerId(e,n);if(!listeners[o]&&(listeners[o]=[],"ThunderJS"!==e)){var r={event:n,id:o.split(".").slice(0,-1).join(".")};this.call(e,"register",r).then().catch()}return listeners[o].push(t),listeners[o].length-1},unregister=function(e,n){var t=makeListenerId(e,n);if(delete listeners[t],"ThunderJS"!==e){var o={event:n,id:t.split(".").slice(0,-1).join(".")};this.call(e,"unregister",o).then().catch()}},thunderJS=function(e){return api=API(e),wrapper(_objectSpread2({},thunder(e),{},plugins))},resolve=function(t,e){"object"===_typeof(t)&&("object"!==_typeof(t)||t.then&&"function"==typeof t.then)||(t=new Promise(function(e,n){t instanceof Error==!1?e(t):n(t)}));var n="function"==typeof e[e.length-1]?e[e.length-1]:null;if(!n)return t;t.then(function(e){return n(null,e)}).catch(function(e){return n(e)})},thunder=function t(e){return{options:e,plugin:!1,call:function(){var e=Array.prototype.slice.call(arguments);this.plugin&&e[0]!==this.plugin&&e.unshift(this.plugin);var n=e[0],t=e[1];return"function"==typeof this[n][t]?this[n][t](e[2]):this.api.request.apply(this,e)},registerPlugin:function(e,n){this[e]=wrapper(Object.assign(Object.create(t),n,{plugin:e}))},subscribe:function(){},on:function(){var e=Array.prototype.slice.call(arguments);return-1<e[0].indexOf("connect","disconnect")?e.unshift("ThunderJS"):this.plugin&&e[0]!==this.plugin&&e.unshift(this.plugin),listener.apply(this,e)},once:function(){console.log("todo ...")}}},wrapper=function e(n){return new Proxy(n,{get:function(o,r){var i=o[r];return"api"===r?api:void 0!==i?"function"==typeof i?-1<["on","once","subscribe"].indexOf(r)?function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return i.apply(this,n)}:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return resolve(i.apply(this,n),n)}:"object"===_typeof(i)?e(Object.assign(Object.create(thunder(o.options)),i,{plugin:r})):i:!1===o.plugin?e(Object.assign(Object.create(thunder(o.options)),{},{plugin:r})):function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return n.unshift(r),o.call.apply(this,n)}}})};module.exports=thunderJS;
