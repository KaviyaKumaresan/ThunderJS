"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var WebSocket=_interopDefault(require("isomorphic-ws"));function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _defineProperty(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function ownKeys(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})),t.push.apply(t,r)}return t}function _objectSpread2(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(t,!0).forEach(function(e){_defineProperty(n,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):ownKeys(t).forEach(function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))})}return n}var requestsQueue={},listeners={},requestQueueResolver=function(e){if(e.id){var n=requestsQueue[e.id];n?("result"in e?n.resolve(e.result):n.reject(e.error),delete requestsQueue[e.id]):console.log("no pending request found with id "+e.id)}},notificationListener=function(n){if(!n.id&&n.method){var e=listeners[n.method];e&&Array.isArray(e)&&e.length?e.forEach(function(e){e(n.params)}):console.log("no callbacks for "+n.method)}},endpoint="/jsonrpc",protocols="notification",connection=null,socket=null,connect=function(t){return new Promise(function(e,n){if(connection)e(connection);else try{socket||((socket=new WebSocket("ws://"+t.host+endpoint,protocols)).addEventListener("message",function(e){requestQueueResolver(JSON.parse(e.data))}),socket.addEventListener("message",function(e){notificationListener(JSON.parse(e.data))})),socket.addEventListener("open",function(){e(connection=socket)})}catch(e){n(e)}})},makeBody=function(e,n,t,r,o){r&&delete r.version;var i={jsonrpc:"2.0",id:e,method:[n,o,t].join(".")};return!r&&!1!==r||"object"===_typeof(r)&&0===Object.keys(r).length||(i.params=r),i},getVersion=function(e,n,t){var r;return(r=t&&t.version)?r:e&&(e[n]||e.default)||1},id=0,makeId=function(){return id+=1},execRequest=function(e,n){connect(e).then(function(e){e.send(JSON.stringify(n))}).catch(console.error)},API=function(c){return{request:function(i,s,u){return new Promise(function(e,n){var t=makeId(),r=getVersion(c.versions,i,u),o=makeBody(t,i,s,u,r);c.debug&&(console.log(" "),console.log("API REQUEST:"),console.log(JSON.stringify(o,null,2)),console.log(" ")),requestsQueue[t]={body:o,resolve:e,reject:n},execRequest(c,o)})}}},DeviceInfo={freeRam:function(e){return this.call("systeminfo",e).then(function(e){return e.freeram})},version:function(e){return this.call("systeminfo",e).then(function(e){return e.version})}},plugins={DeviceInfo:DeviceInfo};function listener(n,t,e){var r=this,o=register.call(this,n,t,e);return{dispose:function(){var e=makeListenerId(n,t);listeners[e].splice(o,1),0===listeners[e].length&&unregister.call(r,n,t)}}}var api,makeListenerId=function(e,n){return["client",e,"events",n].join(".")},register=function(e,n,t){var r=makeListenerId(e,n);if(!listeners[r]){listeners[r]=[];var o={event:n,id:r.split(".").slice(0,-1).join(".")};this.api.request(e,"register",o).then().catch()}return listeners[r].push(t),listeners[r].length-1},unregister=function(e,n){var t=makeListenerId(e,n);delete listeners[t];var r={event:n,id:t.split(".").slice(0,-1).join(".")};this.api.request(e,"unregister",r)},thunderJS=function(e){return api=API(e),wrapper(_objectSpread2({},thunder(e),{},plugins))},resolve=function(t,e){"object"===_typeof(t)&&("object"!==_typeof(t)||t.then&&"function"==typeof t.then)||(t=new Promise(function(e,n){t instanceof Error==!1?e(t):n(t)}));var n="function"==typeof e[e.length-1]?e[e.length-1]:null;if(!n)return t;t.then(function(e){return n(null,e)}).catch(function(e){return n(e)})},thunder=function t(e){return{options:e,plugin:!1,call:function(){var e=Array.prototype.slice.call(arguments);this.plugin&&e[0]!==this.plugin&&e.unshift(this.plugin);var n=e[0],t=e[1];return"function"==typeof this[n][t]?this[n][t](e[2]):this.api.request.apply(this,e)},registerPlugin:function(e,n){this[e]=wrapper(Object.assign(Object.create(t),n,{plugin:e}))},subscribe:function(){},on:function(){var e=Array.prototype.slice.call(arguments);return this.plugin&&e[0]!==this.plugin&&e.unshift(this.plugin),listener.apply(this,e)},once:function(){console.log("todo ...")}}},wrapper=function e(n){return new Proxy(n,{get:function(r,o){var i=r[o];return"api"===o?api:void 0!==i?"function"==typeof i?-1<["on","once","subscribe"].indexOf(o)?function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return i.apply(this,n)}:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return resolve(i.apply(this,n),n)}:"object"===_typeof(i)?e(Object.assign(Object.create(thunder(r.options)),i,{plugin:o})):i:!1===r.plugin?e(Object.assign(Object.create(thunder(r.options)),{},{plugin:o})):function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return n.unshift(o),r.call.apply(this,n)}}})};module.exports=thunderJS;
